name: Publish Clebrain Build of Apollo Kotlin to GitHub

on:
  release:
    types: [ created ]

jobs:
  publish:
    if: ${{ contains(github.ref_name, '-clebrain') }}
    runs-on:
      labels: macOS
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          server-id: github
          settings-path: ${{ github.workspace }}
      - name: Setup the Android SDK
        uses: android-actions/setup-android@v2
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5
      - name: Publish to GitHub Packages
        run: |
          ./gradlew \
            --no-configuration-cache \
            --no-build-cache \
            publish
        env:
          USERNAME: ${{ github.actor }}
          GH_TOKEN: ${{ secrets.CLEBRAIN_CI_TOKEN }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISABLE_WATCH_TV_OS: true
          DISABLE_LINUX: true
          DISABLE_JS: true
      - name: Clean the build result
        if: always()
        run: |
          ./gradlew \
            --no-configuration-cache \
            --no-build-cache \
            clean